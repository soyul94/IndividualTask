<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.soyul.review.service.impl.ReviewMapper"> <!-- 이 mapper namespace가 찾아가는 경로이므로 꼭 정확히 명시해야한다. -->

	<resultMap id="reviewVO" type="egovframework.soyul.review.ReviewVO">
		<result property="reviewId" column="REVIEW_ID"/>
		<result property="reviewSj" column="REVIEW_SJ"/>
		<result property="reviewCn" column="REVIEW_CN"/>
		<result property="skinType" column="SKIN_TYPE"/>
		<result property="reviewProduct" column="REVIEW_PRODUCT"/>
		<result property="inqireCo" column="INQIRE_CO"/>
		<result property="creatIp" column="CREAT_IP"/>
		<result property="noticeAt" column="NOTICE_AT"/>
		<result property="othbcAt" column="OTHBC_AT"/>
		<result property="useAt" column="USE_AT"/>
		<result property="atchFileId" column="ATCH_FILE_ID"/>
		<result property="frstRegistPnttm" column="FRST_REGIST_PNTTM"/>
		<result property="frstRegisterId" column="FRST_REGISTER_ID"/>
	</resultMap>


	<select id="selectReview" resultMap="reviewVO">
		SELECT
			REVIEW_ID,
			REVIEW_SJ,
			REVIEW_CN,
			SKIN_TYPE,
			REVIEW_PRODUCT,
			INQIRE_CO,
			CREAT_IP,
			NOTICE_AT,
			OTHBC_AT,
			USE_AT,
			ATCH_FILE_ID,
			FRST_REGIST_PNTTM,
			FRST_REGISTER_ID
		FROM REVIEW 
		WHERE REVIEW_ID=#{reviewId} AND USE_AT='Y'		
	</select>


	<select id="selectReviewList" resultType="egovMap">
		SELECT
			A.REVIEW_ID,
			A.REVIEW_SJ,
			A.REVIEW_CN,
			A.SKIN_TYPE,
			A.REVIEW_PRODUCT,
			A.INQIRE_CO,
			A.CREAT_IP,
			A.NOTICE_AT,
			A.OTHBC_AT,
			A.USE_AT,
			A.ATCH_FILE_ID,
			A.FRST_REGIST_PNTTM,
			A.FRST_REGISTER_ID,
			(SELECT CONCAT(X.STRE_FILE_NM,'.',X.FILE_EXTSN) FROM LETTNFILEDETAIL X
			 WHERE X.ATCH_FILE_ID = A.ATCH_FILE_ID AND UPPER(FILE_EXTSN) IN('GIF','JPG','JPEG','BMP','PNG') 
			 ORDER BY FILE_SN LIMIT 1
			 )AS ATCH_FILE_NM
		FROM REVIEW A
		<include refid="selectReviewListWhere"/>
		ORDER BY A.FRST_REGIST_PNTTM DESC
		
		<if test='noticeAt != "Y"'>
			LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
		</if>
	</select>
	
	
	<select id="selectReviewListCnt" resultType="java.lang.Integer">
		SELECT COUNT(*) FROM REVIEW A
		<include refid="selectReviewListWhere"/>
	</select>


	<sql id="selectReviewListWhere">
		<where>
			A.USE_AT='Y'
			<choose>
				<when test='noticeAt=="Y"'>
					AND A.NOTICE_AT = 'Y'
				</when>
				<otherwise>
					<if test='searchCondition != null and searchCondition != ""'>
						<choose>
							<when test='searchCondition == "0"'>
								AND A.REVIEW_SJ LIKE CONCAT('%',#{serchKeyword},'%')
								<!-- #{}변수로 값을 넣어야해서 CONCAT을 이용하여 하나의 문자열로 만듬 -->
							</when>
							<when test='searchCondition == "1"'>
								AND A.REVIEW_CN LIKE CONCAT('%',#{serchKeyword},'%')
							</when>
							<when test='searchCondition == "2"'>
								AND A.FRST_REGISTER_ID LIKE CONCAT('%',#{serchKeyword},'%')
							<!-- LIKE '%000%' 으로 양 옆에 %를 붙여 사용하면 검색 정확도는 높으나 쿼리 처리가 매우 느림 -->
							</when>
							<when test='searchCondition == "1"'>
								AND A.SKIN_TYPE LIKE CONCAT('%',#{serchKeyword},'%')
							</when>
						</choose>
						<!-- 전체 검색은 있는 조건을 모두 OR연산 해준 것. -->
					</if>
				</otherwise>
			</choose>
		</where>
	</sql>
	
	
	<update id="updateViewCnt" parameterType="egovframework.soyul.review.ReviewVO">
		UPDATE REVIEW SET INQIRE_CO = INQIRE_CO+1
		WHERE REVIEW_ID = #{reviewId}
	</update>
	
	
	<insert id="insertReview" parameterType="egovframework.soyul.review.ReviewVO">
		insert into REVIEW(
			REVIEW_ID,
			REVIEW_SJ,
			REVIEW_CN,
			SKIN_TYPE,
			REVIEW_PRODUCT,
			INQIRE_CO,
			CREAT_IP,
			NOTICE_AT,
			OTHBC_AT,
			USE_AT,
			ATCH_FILE_ID,
			FRST_REGIST_PNTTM,
			FRST_REGISTER_ID,
			LAST_UPDT_PNTTM,
			LAST_UPDUSR_ID
		) values(	<!-- insert할 때 각 컬럼이 사용자에게 정보를 받아야하는지 DB에서 가져오는지 구분지어봐야햐한다. -->
			#{reviewId},
			#{reviewSj},
			#{reviewCn},
			#{skinType},
			#{reviewProduct},
			0,		<!-- 생성 시 조회수는 당연하게 0 -->
			#{creatIp},
			#{noticeAt},
			#{othbcAt},
			'Y', 	<!-- 생성 시 사용여부는 디폴트로 Y (이건 추후 관리로 변경함) -->
			#{atchFileId},
			now(),
			#{userId},
			now(),
			#{userId}
		)
	</insert>
	
	
	<update id="updateReview" parameterType="egovframework.soyul.review.ReviewVO">
		update REVIEW set
			REVIEW_SJ=#{reviewSj},
			REVIEW_CN=#{reviewCn},
			SKIN_TYPE=#{skinType},
			REVIEW_PRODUCT=#{reviewProduct},
			NOTICE_AT=#{noticeAt},
			OTHBC_AT=#{othbcAt},
			<if test='atchFileId != null and atchFileId !=""'>
				ATCH_FILE_ID=#{atchFileId},
			</if>
			LAST_UPDT_PNTTM=NOW(),
			LAST_UPDUSR_ID=#{userId}
		where REVIEW_ID=#{reviewId}
		<if test='mngAt != "Y"'> <!-- 타 아이디가 접근해서 삭제하지 못하도록 방지 (3차 방어) -->
			and FRST_REGISTER_ID=#{userId}
		</if>
	</update>
	
	
	<delete id="deleteReview" parameterType="egovframework.soyul.review.ReviewVO">
		<!-- DELETE FROM BOARD WHERE BOARD_ID=#{userId} -->
		update REVIEW set USE_AT = 'N'
		where REVIEW_ID = #{reviewId}
		<if test='mngAt != "Y"'>
			and FRST_REGISTER_ID = #{userId}
		</if>
	</delete>
	
</mapper>
